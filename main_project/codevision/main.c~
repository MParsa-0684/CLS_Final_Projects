// language: c
/*******************************************************
Project : BadUSB Simulation (ATtiny85)
Clock   : 8.000000 MHz (Internal RC)
Target  : ATtiny85
*******************************************************/

#include <tiny85.h>
#include <delay.h>

//  ⁄—Ì› ÅÌ‰ùÂ«
#define TX_PIN PINB.0   // ÅÌ‰ «—”«· ”—Ì«·
#define BUTTON PINB.4   // ÅÌ‰ œò„Â

//  «»⁄ «—”«· ”—Ì«· ‰—„ù«›“«—Ì (Bit-Banging)
// Baud Rate: 9600 @ 8MHz Clock
// Bit time = 1/9600 = ~104 us
void uart_tx(char data) {
    unsigned char i;
    
    // Start Bit (Low)
    PORTB.0 = 0;
    delay_us(104);
    
    // 8 Data Bits (LSB first)
    for (i = 0; i < 8; i++) {
        if (data & 1) 
            PORTB.0 = 1;
        else 
            PORTB.0 = 0;
        
        data >>= 1;
        delay_us(104);
    }
    
    // Stop Bit (High)
    PORTB.0 = 1;
    delay_us(104);
}

//  «»⁄ «—”«· —‘ Â (String)
void send_string(char *str) {
    while (*str) {
        uart_tx(*str);
        str++;
    }
    // «—”«· Å«Ì«‰ Œÿ »—«Ì «Ì‰òÂ Å«Ì Ê‰ »›Â„œ œ” Ê—  „«„ ‘œÂ
    uart_tx('\n'); 
}

void main(void) {
    //  ‰ŸÌ„«  ÅÊ— ùÂ«
    // PB0: Output (TX)
    // PB4: Input (Button)
    DDRB = (0<<DDB5) | (0<<DDB4) | (0<<DDB3) | (0<<DDB2) | (0<<DDB1) | (1<<DDB0);
    
    // Ê÷⁄Ì  «Ê·ÌÂ
    PORTB = (1<<PORTB4) | (1<<PORTB0); // ›⁄«·ù”«“Ì Pull-up »—«Ì œò„Â Ê High ò—œ‰ TX
    
    //  «ŒÌ— «Ê·ÌÂ »—«Ì Å«Ìœ«—Ì ”Ì” „ Ê ¬„«œÂ ‘œ‰ «”ò—ÌÅ  Å«Ì Ê‰
    delay_ms(3000);

    // ==========================================
    // ›«“ ?: «” Œ—«Ã IP Ê –ŒÌ—Â œ— ›«Ì· («Ã—«Ì ŒÊœò«—)
    // ==========================================
    
    // 1. »«“ ò—œ‰ Å‰Ã—Â Run
    send_string("#R");
    delay_ms(1000); // ’»— »—«Ì »«“ ‘œ‰ Å‰Ã—Â œ— ÊÌ‰œÊ“
    
    // 2.  «ÌÅ œ” Ê— CMD »—«Ì «” Œ—«Ã IP
    // œ” Ê—: cmd /c "ipconfig | findstr IPv4 > %TEMP%\temp_ip.txt"
    // «“ %TEMP% «” ›«œÂ „Ìùò‰Ì„  « ‰Ì«“ »Â œ” —”Ì «œ„Ì‰ ‰»«‘œ
    send_string("cmd /c \"ipconfig | findstr IPv4 > %TEMP%\\temp_ip.txt\"");
    delay_ms(500);
    
    // 3. “œ‰ «Ì‰ — »—«Ì «Ã—«
    send_string("#E");
    
    // Ìò  «ŒÌ— »·‰œ »—«Ì «ÿ„Ì‰«‰ «“ «‰Ã«„ ⁄„·Ì«  CMD
    delay_ms(2000);

    // ==========================================
    // ›«“ ?: Õ·ﬁÂ «‰ Ÿ«— »—«Ì œò„Â (‰„«Ì‘ IP)
    // ==========================================
    while (1) {
        // çò ò—œ‰ ›‘—œÂ ‘œ‰ œò„Â (Active Low)
        if (BUTTON == 0) {
            delay_ms(50); // Debounce (Õ–› ·—“‘ ò·Ìœ)
            if (BUTTON == 0) {
                
                // 1. »«“ ò—œ‰ Å‰Ã—Â Run
                send_string("#R");
                delay_ms(1000);
                
                // 2. »«“ ò—œ‰ ‰Ê ùÅœ Ê ŒÊ«‰œ‰ ›«Ì·
                send_string("notepad %TEMP%\\temp_ip.txt");
                delay_ms(500);
                
                // 3. «Ã—«
                send_string("#E");
                
                // ’»—  « “„«‰Ì òÂ œ”  «“ —ÊÌ œò„Â »—œ«‘ Â ‘Êœ (»—«Ì Ã·ÊêÌ—Ì «“  ò—«—)
                while(BUTTON == 0);
                delay_ms(500);
            }
        }
    }
}
